{% extends 'base.html.twig' %}

{% block title %}{{pagina|default('') }}{% endblock %}

{% block body %}
   
<div class="row">
  <div class="col-md-12 col-sm-12 ">
    <div class="card card-primary">
      <div class="card-body">
        <div class="d-flex justify-content-center">
          <div class="card card-primary">
            <div class="card-body p-0">
              
              <div style="background:#2711dc;color:#fff ">
                Recordatorio
              </div>
              <div style="background:#32c41b;color:#fff">
                Tarea
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-md-12 col-sm-12">
    <div class="card card-primary">
        <div class="card-body p-0">
            <!-- THE CALENDAR -->
            <div id="calendar"></div>
        </div>
        <!-- /.card-body -->
    </div>
    <!-- /.card -->
  </div>
</div>
<!-- Modal Fuera de fecha -->
<div class="modal fade" id="modalFueraPlazo">
        <div class="modal-dialog">
          <div class="modal-content ">
            <div class="modal-header bg-danger">
              <h4 class="modal-title">Fuera de rango</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
              <p>No puede ingresar el mensaje, se encuentra fuera del plazo.</p>
              
            </div>
            <div class="modal-footer justify-content-between">
              <button type="button" class="btn btn-outline-dark" data-dismiss="modal">Cerrar</button>
              
            </div>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
      <!-- /.modal -->


<!-- modal crear recordatorio -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            {{ form_start(form) }}
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Crear Mensaje</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                
                <div class="row">
                    <div class="col-sm-12 col-md-6">
                        <small class="text-muted">Seleccione Tipo</small>
                        {{ form_row(form.mensajeTipo,{'label':false,'attr':{'class':'form-control mensaje_tipo'}})}}
                    </div>
                    <div class="col-sm-12 col-md-6">
                        <small class="text-muted">Usuario Destino</small>
                        {{ form_row(form.usuarioDestino,{'label':false,'attr':{'class':'form-control usuario_destino'}})}}
                    </div>
                    <div class="col-sm-12 col-md-6 ">
                        <small class="text-muted">Seleccione Fecha</small>
                        <p class="fecha_aviso_html"></p>
                        {{ form_row(form.fechaAviso,{'label':false,'attr':{'class':'form-control fecha_aviso ocultar-campo'}})}}
                    </div>
                    <div class="col-sm-12 col-md-12">
                        <small class="text-muted">Observaci√≥n</small>
                        {{ form_row(form.observacion,{'label':false,'attr':{'class':'form-control'}})}}
                    </div>
                </div>
                
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Crear</button>
            </div>
            {{ form_end(form) }}
        </div>
    </div>
</div>


<script>
  $(function () {

    $('.usuario_destino').append($('<option>', {
        value: 0,
        text: 'Seleccione'
    }));
    $('.usuario_destino').val('0').change();


    /* initialize the external events
     -----------------------------------------------------------------*/
    function ini_events(ele) {
      ele.each(function () {

        // create an Event Object (http://arshaw.com/fullcalendar/docs/event_data/Event_Object/)
        // it doesn't need to have a start or end
        var eventObject = {
          title: $.trim($(this).text()) // use the element's text as the event title
        }

        // store the Event Object in the DOM element so we can get to it later
        $(this).data('eventObject', eventObject)

        // make the event draggable using jQuery UI
        $(this).draggable({
          zIndex        : 1070,
          revert        : true, // will cause the event to go back to its
          revertDuration: 0  //  original position after the drag
        })

      })
    }

    ini_events($('#external-events div.external-event'))

    /* initialize the calendar
     -----------------------------------------------------------------*/
    //Date for the calendar events (dummy data)
    var date = new Date()
    var d    = date.getDate(),
        m    = date.getMonth(),
        y    = date.getFullYear()

    var Calendar = FullCalendar.Calendar;
    var Draggable = FullCalendarInteraction.Draggable;

    var containerEl = document.getElementById('external-events');
    var checkbox = document.getElementById('drop-remove');
    var calendarEl = document.getElementById('calendar');

    // initialize the external events
    // -----------------------------------------------------------------

    

    var calendar = new Calendar(calendarEl, {
      plugins: [ 'Yeti', 'interaction', 'dayGrid', 'timeGrid' ],
      selectable: true,
      nowIndicator: false,
      locale: 'es',
      header    : {
        left  : 'prev,next today',
        center: 'title',
        right : 'dayGridMonth,dayGridWeek,dayGridDay'
      },
      dateClick: function(info) {
        
        if(moment().format('YYYY-MM-DD')<=moment(info.dateStr).format('YYYY-MM-DD')){
            $('.fecha_aviso').val(info.dateStr);
            $('.fecha_aviso_html').html(info.dateStr);
            $('#exampleModal').modal('show');
        }else{
            $('#modalFueraPlazo').modal('show');
        }
      },

      eventClick: function(info) {
        var eventObj = info.event;

        console.log(eventObj);

        //$('#detalleModal').modal('show');
        window.open('/mensaje/'+eventObj.id,'_self');
        info.jsEvent.preventDefault();
        if (eventObj.url) {
          /*alert(
            'Clicked ' + eventObj.title + '.\n' +
            'Will open ' + eventObj.url + ' in a new tab'
          );

          window.open(eventObj.url);*/

          //; // prevents browser from following link in current tab.
        } else {
          //alert('Clicked ' + eventObj.id);
        }
      },

      'themeSystem': 'bootstrap',
      //Random default events
      events    : [
        {% set i=0 %}
        {% for mensaje in mensajes %}
            {% if i>0 %}
            , 
            {% endif %}
            {
                title          : '{{mensaje.usuarioDestino.nombre}}: {{ mensaje.observacion }}',
                start          : '{{mensaje.fechaAviso|date('Y-m-d')}}',
                {% if mensaje.mensajeTipo.id == 1 %}
                backgroundColor: '#2711dc', 
                borderColor    : '#fff', 
                textColor     : '#fff',
                
                {% else %}   
                backgroundColor: '#32c41b', //red
                borderColor    : '#fff', //red
                textColor       : '#fff',
                {% endif %}
               
                allDay         : true,
                id             : {{ mensaje.id }}
            }
            

            {% set i=i+1 %}
        {% endfor %}
      ],
      editable  : true,
      droppable : true, // this allows things to be dropped onto the calendar !!!
      drop      : function(info) {
        // is the "remove after drop" checkbox checked?
        if (checkbox.checked) {
          // if so, remove the element from the "Draggable Events" list
          info.draggedEl.parentNode.removeChild(info.draggedEl);
        }
      }    
    });

    calendar.render();
    // $('#calendar').fullCalendar()

    
  })
</script>
{% endblock %}