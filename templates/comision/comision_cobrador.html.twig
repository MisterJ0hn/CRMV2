{% extends 'base.html.twig' %}
{% block title %}Hello ComisionAgendadorController!{% endblock %}

{% block body %}
<form action="{{path('comision_cobrador')}}" method="get" id="bForm">
    <input type="hidden" name="bStatus" id="bStatus" value="{{status|default('')}}">
<section>

<div class="row">
{%  set resumen = resumenes[0] %}

        <div class="col-sm-6 col-md-3">
            <div class="info-box">
                <span class="info-box-icon bg-warning"><i class="fas fa-retweet"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Recupero</span>
                    <span class="info-box-number">${{resumen[2]|number_format(0,',','.')}}</span>
                    
                    <a href="#" class="small-box-footer" onclick="javascript:buscar(2)">
                        Ver Más <i class="fas fa-arrow-circle-right"></i>
                    </a>
                    
                </div>
                <!-- /.info-box-content -->
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="info-box">
                <span class="info-box-icon bg-success"><i class="far fa-handshake"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Gestiones</span>
                    <span class="info-box-number">{{resumen[1]|number_format(0,',','.')}}</span>
                    
                    <a href="#" class="small-box-footer" onclick="javascript:buscar(1)">
                        Ver Más <i class="fas fa-arrow-circle-right"></i>
                    </a>
                    
                </div>
                <!-- /.info-box-content -->
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="info-box">
                <span class="info-box-icon bg-success"><i class="far fa-handshake"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Max tiempo gestión</span>
                    <span class="info-box-number">{{configuracion.maxDiasComision}}</span>
                    
                    
                    
                </div>
                <!-- /.info-box-content -->
            </div>
        </div>
        
    </div>

</div>
</section>


{% if sesion.getSesion.usuarioTipo.id in [3,1]  %}
    <section>
    {% if resumen[2] %}
        
    
        {% if status %}
                    
            {{ render(controller('App\\Controller\\AgendaController::resumencobradores', {'status':status,'total':resumen[1],'montoTotal':resumen[2]})) }}
       
        {% endif %}
    {% endif %}
    </section>
{% endif %}

<div class="card">
    <div class="card-header">
            <div class="row">
                <div class="col-sm-12 col-md-3">
                    <select name="bCompania" class="form-control">
                        <option value="0">Todos</option>
                        {% for compania in companias %}
                            <option value="{{compania.id}}"
                            {% if bCompania==compania.id %}
                                selected
                            {% endif %}
                            >{{compania.nombre}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-sm-12 col-md-3">
                    <input type="text" class="form-control" name="bFolio" placeholder="Folio/AgendaId" value="{{bFolio}}">
                </div>
                <div class="col-sm-12 col-md-3">
                    <input type="text" class="form-control" name="bFecha" id="bFecha"  value="">
                </div>
                <div class="col-sm-12 col-md-3">
                    <button type="button" class="btn btn-primary bBuscar" ><i class="fas fa-search"></i></button>
                    <input type="hidden" name="bNueva" class="bNueva" value="0">
                    <button type="button" class="btn btn-primary bXls" ><i class="fas fa-file"></i></button>
                </div>
                <div class="col-sm-12 col-md-3">       
                </div>
            </div>
    </div>
</form>
    <div class="card-body table-responsive p-0" style="height: 500px;">
        <div class="progress-data progress">
        </div>
        <div class="progress-msg">
        </div>
        <table class="table">
            <thead>
                <tr>
                    
                    <th>{{ knp_pagination_sortable(agendas, 'Folio', 'contrato.folio') }} {% if agendas.isSorted('contrato.folio') %} <i class="fas fa-sort"></i>{% endif %}</th>
                    <th>{{ knp_pagination_sortable(agendas, 'AgendaId', 'contrato.agenda.id') }} {% if agendas.isSorted('contrato.agenda.id') %} <i class="fas fa-sort"></i>{% endif %}</th>
                    <th>{{ knp_pagination_sortable(agendas, 'Cobrador', 'cobranza.usuarioRegistro.nombre') }} {% if agendas.isSorted('cobranza.usuarioRegistro.nombre') %} <i class="fas fa-sort"></i>{% endif %}</th>
                    <th>{{ knp_pagination_sortable(agendas, 'Ultima Gestión', 'cobranza.fechaHora') }} {% if agendas.isSorted('cobranza.fechaHora') %} <i class="fas fa-sort"></i>{% endif %}</th>
                    <th>{{ knp_pagination_sortable(agendas, 'Pago', 'pago.fechaPago') }} {% if agendas.isSorted('pago.fechaPago') %} <i class="fas fa-sort"></i>{% endif %}</th>
                    <th>{{ knp_pagination_sortable(agendas, 'Cuota', 'cuota.fechaPago') }} {% if agendas.isSorted('cuota.fechaPago') %} <i class="fas fa-sort"></i>{% endif %}</th>
                    <th>{{ knp_pagination_sortable(agendas, 'Tiempo Mora', 'diasMora') }} {% if agendas.isSorted('diasMora') %} <i class="fas fa-sort"></i>{% endif %}</th>
 
                    <th>{{ knp_pagination_sortable(agendas, '$ Pagó', 'pago.monto') }} {% if agendas.isSorted('pago.monto') %} <i class="fas fa-sort"></i>{% endif %}</th>
                </tr>
            </thead>
            <tbody>
            {% for agenda in agendas %}
                <tr>
   
                    <td>{{ agenda.contrato.folio }}</td>
                    <td>{{ agenda.contrato.agenda.id }}</td>
                    <td>{{agenda.cobranza.usuarioRegistro.nombre}}
                    </td>
                    <td>{{ agenda.cobranza.fechaHora|date('Y-m-d H:i') }}</td>
                    <td>{{ agenda.pago.fechaPago|date('Y-m-d H:i') }}</td>
                    <td>{{ agenda.cuota.fechaPago|date('Y-m-d') }}</td>
                    <td>{{ agenda.diasMora }}</td>
                    <td>{{ agenda.monto|number_format(0, ',', '.') }}</td>
                    
                </tr>
            {% else %}
                <tr>
                    <td colspan="7" >no records found</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        <div class="card-footer clearfix">
            {# display navigation #}
       <div class="navigation">
           {{ knp_pagination_render(agendas,'@KnpPaginator/Pagination/twitter_bootstrap_v4_pagination.html.twig',{},{
           'position': 'centered',
           'rounded': true,
           }) }}
       </div>
   </div>

   <!-- Modal modificacion sucursal-->
<div class="modal-dialog modal-lg">
    <div class="modal fade" id="verGestiones" data-backdrop="static" data-keyboard="false"  >
        <div class="modal-body">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel"> Gestiones</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                       
                    </div>
 
                    <div class="modal-body detalle">
                        
                        
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $('#bFecha').daterangepicker({
        "drops": "down",
        "startDate":"{{dateInicio}}",
        "endDate": "{{dateFin}}",
        "locale": {
            "format": "YYYY-MM-DD",
            "applyLabel": "Apply",
            "cancelLabel": "Cancel",
        }
    }, function(start, end, label) {
    console.log('New date range selected: ' + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD') + ' (predefined range: ' + label + ')');
    
    });
    function buscar(status){
        $("#bStatus").val(status);
        $("#bForm").submit();
    }
    $('.bBuscar').on('click',function(){
        $(".bNueva").val("1");
        $("#bForm").attr("action",'{{path('comision_generar_cobrador')}}');
        $("#bForm").submit();
    });
    $('.bXls').on('click',function(){
        $(".bNueva").val("1");
        $("#bForm").attr('action',"{{path('comision_generar_cobrador_xls')}}");


        $("#bForm").submit();
        $("button").prop('disabled',false);
    });
    function verGestiones(id){
        $.ajax({
			url:"/comision/"+id+"/gestiones_cobrador",
			type: "get",
			data: "pageId="+id,
			dataType: "html",
			cache: false,
			contentType: false,
			processData: false,
			async: true,
			beforeSend: function(){
					
				},
			success:function(data){ 
				$('.detalle').html(data);
                $('#verGestiones').modal('show')
				
				
			}
		});

    }


    
    setInterval(
        function(){
            
            if({{porcentaje}}<100){
                $(".table").hide();
                $(".bBuscar").prop('disabled',true);
                $(".info-box-content").hide();
                $.ajax({
                    url:"{{ path('importacion_por_com_cob', {'id':usuario.id}) }}",
                    type: "post",
                    dataType: "json",
                    cache: false,
                    contentType: false,
                    processData: false,
                    async: true,
                    beforeSend: function(){
                            
                        },
                    success:function(data){ 
                        let mensaje='Espere un momento';
                        if(data.porcentaje>=25){
                             mensaje='Estamos recopilando la información para ser presentada en pantalla';
                        }
                        if(data.porcentaje>=70){
                             mensaje='Ya estamos terminando!!';
                        }
                        if(data.porcentaje>=90){
                             mensaje='Ahora mostraremos los datos';
                        }
                        let html='<div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="'+data.porcentaje+'" aria-valuemin="0" aria-valuemax="100" style="width: '+data.porcentaje+'%">'+data.porcentaje+'%</div>';
                        let html_msg='<div><p class="text-center">'+mensaje+'</p></div>';
                        $('.progress-data').html(html);
                        $('.progress-msg').html(html_msg);
                        if(data.porcentaje>=100){
                            location.reload();
                        }
                    }
                });
            }
        },
        2000
    );
    

</script>

{% endblock %}